{% extends 'base.html' %}
{% load static %}

{% block title %}My Profile ‚Äî MindScan{% endblock %}

{% block nav_links %}
<li><a href="{% url 'SearchFriends' %}" id="nav-friends">Search Friends</a></li>
<li><a href="{% url 'UploadPost' %}" id="nav-upload">Upload Post</a></li>
<li><a href="{% url 'BrowseExperiences' %}" id="nav-experiences">Browse Stories</a></li>
<li><a href="{% url 'MotivatedText' %}" id="nav-motivated">Support Posts</a></li>
<li><a href="{% url 'UserProfile' %}" class="active" id="nav-profile">My Profile</a></li>
<li><a href="{% url 'index' %}" id="nav-logout">Logout</a></li>
{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="page-header">
        <h1 class="page-title">üë§ My Profile</h1>
        <p class="page-subtitle">Welcome, <strong>{{ username }}</strong>. Manage your posts and view your progress.</p>
    </div>

    <div class="profile-layout" style="display: grid; gap: 2rem; grid-template-columns: 1fr;">
        <!-- IMAGE POSTS HISTORY -->
        <div class="content-card">
            <div class="content-card-header"
                style="display: flex; justify-content: space-between; align-items: center;">
                <h3>üì∏ Image Analysis History</h3>
                <span class="badge"
                    style="background: var(--primary); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem;">
                    {{ image_posts|length }} Posts
                </span>
            </div>
            <div class="content-card-body">
                {% if image_posts %}
                <div class="table-container" style="overflow-x: auto;">
                    <table class="table table-striped">
                        <thead>
                            <tr class="thead-dark">
                                <th>Date & Time</th>
                                <th>Result</th>
                                <th>Details</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for post in image_posts %}
                            <tr id="post-row-{{ post.0 }}">
                                <td style="font-size: 0.85rem; color: var(--text-muted);">{{ post.2 }}</td>
                                <td>
                                    {% if post.3 == 'Negative' %}
                                    <span style="color: #ff6b6b; font-weight: bold;"><i class="fas fa-frown"></i>
                                        Depressed</span>
                                    {% else %}
                                    <span style="color: #51cf66; font-weight: bold;"><i class="fas fa-smile"></i>
                                        Healthy</span>
                                    {% endif %}
                                </td>
                                <td style="color: var(--text-muted); font-size: 0.85rem;">{{ post.1 }}</td>
                                <td>
                                    <button onclick="confirmDeletePost({{ post.0 }})" class="btn-delete"
                                        style="background: rgba(255, 107, 107, 0.1); color: #ff6b6b; border: 1px solid #ff6b6b; padding: 5px 10px; border-radius: 4px; cursor: pointer; transition: all 0.2s;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div style="text-align: center; padding: 30px; color: var(--text-muted);">
                    <i class="fas fa-images" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                    <p>No image analysis history yet. <a href="{% url 'UploadPost' %}"
                            style="color: var(--primary);">Upload your first image!</a></p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- EXPERIENCES HISTORY -->
        <div class="content-card">
            <div class="content-card-header"
                style="display: flex; justify-content: space-between; align-items: center;">
                <h3>‚úçÔ∏è My Shared Experiences</h3>
                <span class="badge"
                    style="background: var(--accent); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem;">
                    {{ experience_posts|length }} Stories
                </span>
            </div>
            <div class="content-card-body">
                {% if experience_posts %}
                <div class="experience-list" style="display: grid; gap: 1rem;">
                    {% for exp in experience_posts %}
                    <div class="experience-history-item" id="exp-row-{{ exp.0 }}"
                        style="border: 1px solid rgba(88, 166, 255, 0.2); border-radius: 8px; padding: 15px; position: relative; background: rgba(255,255,255,0.02);">
                        <div
                            style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: var(--primary); font-size: 1.1rem;">{{ exp.1 }}</h4>
                            <button onclick="confirmDeleteExperience({{ exp.0 }})" class="btn-delete"
                                style="background: #ff6b6b; color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px; line-height: 1.5;">
                            {{ exp.2|truncatechars:150 }}</p>
                        <div style="font-size: 0.75rem; color: #777;">
                            <i class="fas fa-clock"></i> Posted on {{ exp.3 }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div style="text-align: center; padding: 30px; color: var(--text-muted);">
                    <i class="fas fa-edit" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                    <p>You haven't shared any experiences yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    .btn-delete:hover {
        background: #ff6b6b !important;
        color: white !important;
        transform: scale(1.05);
    }

    .experience-history-item:hover {
        border-color: var(--primary) !important;
        box-shadow: 0 4px 12px rgba(88, 166, 255, 0.1);
    }
</style>

{% endblock %}

{% block scripts %}
<script>
    function confirmDeletePost(postId) {
        if (confirm("Are you sure you want to delete this analysis result?")) {
            const formData = new FormData();
            formData.append('post_id', postId);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch("{% url 'DeletePost' %}", {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        document.getElementById(`post-row-${postId}`).style.opacity = '0';
                        setTimeout(() => {
                            document.getElementById(`post-row-${postId}`).remove();
                            location.reload(); // Refresh to update count
                        }, 300);
                    } else {
                        alert("Error deleting post.");
                    }
                })
                .catch(error => console.error('Error:', error));
        }
    }

    function confirmDeleteExperience(expId) {
        if (confirm("Are you sure you want to delete this experience story?")) {
            const formData = new FormData();
            formData.append('exp_id', expId);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch("{% url 'DeleteExperience' %}", {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        document.getElementById(`exp-row-${expId}`).style.opacity = '0';
                        setTimeout(() => {
                            document.getElementById(`exp-row-${expId}`).remove();
                            location.reload(); // Refresh to update count
                        }, 300);
                    } else {
                        alert("Error deleting experience.");
                    }
                })
                .catch(error => console.error('Error:', error));
        }
    }
</script>
{% endblock %}